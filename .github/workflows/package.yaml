name: Build Windows EXE for WMS-RuoYi

on:
  push:
    branches: [ lite, advance, master, v1 ]
  workflow_dispatch:

jobs:
  build-windows-exe:
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šè‡ªåŠ¨é€‚é… JDK ç‰ˆæœ¬
      - name: Setup JDK (Auto Match Branch)
        uses: actions/setup-java@v4
        with:
          java-version: ${{ github.ref_name == 'v1' ? '8' : '17' }}
          distribution: 'temurin'
          cache: 'maven'

      # æ­¥éª¤3ï¼šé…ç½® Maven é˜¿é‡Œäº‘é•œåƒï¼ˆå¢åŠ è¶…æ—¶/é‡è¯•ï¼‰
      - name: Configure Maven Settings
        run: |
          New-Item -Path $env:USERPROFILE\.m2 -ItemType Directory -Force
          @"
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
            <mirrors>
              <mirror>
                <id>aliyunmaven</id>
                <mirrorOf>central</mirrorOf>
                <url>https://maven.aliyun.com/repository/public</url>
              </mirror>
              <mirror>
                <id>central</id>
                <url>https://repo1.maven.org/maven2</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
            <profiles>
              <profile>
                <id>maven</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                  <maven.wagon.http.connectionTimeout>30000</maven.wagon.http.connectionTimeout>
                  <maven.wagon.http.retryHandler.count>3</maven.wagon.http.retryHandler.count>
                </properties>
              </profile>
            </profiles>
          </settings>
          "@ | Out-File -FilePath $env:USERPROFILE\.m2\settings.xml -Encoding utf8
        shell: pwsh

      # æ­¥éª¤4ï¼šMaven æ‰“åŒ…ï¼ˆå¢åŠ è¯¦ç»†æ—¥å¿—ï¼‰
      - name: Build Jar with Maven
        run: |
          # å¢åŠ  -X å¯æŸ¥çœ‹è¯¦ç»†ä¾èµ–æ—¥å¿—ï¼Œå¤±è´¥æ—¶ä¾¿äºæ’æŸ¥
          mvn clean package -DskipTests -X
        shell: cmd

      # æ­¥éª¤5ï¼šæ ¡éªŒ Jar åŒ…æ˜¯å¦ç”Ÿæˆ
      - name: Check Jar File Exists
        run: |
          $JAR_PATH = ".\ruoyi-admin-wms\target\*.jar"
          $JAR_FILE = Get-ChildItem $JAR_PATH | Select-Object -First 1
          if (-not $JAR_FILE) {
              Write-Error "âŒ æœªæ‰¾åˆ° Jar åŒ…ï¼Œè¯·æ£€æŸ¥ Maven æ‰“åŒ…æ­¥éª¤ï¼"
              Write-Host "ğŸ“‚ target ç›®å½•å†…å®¹ï¼š"
              Get-ChildItem .\ruoyi-admin-wms\target -ErrorAction SilentlyContinue
              exit 1
          } else {
              Write-Host "âœ… æ‰¾åˆ° Jar åŒ…ï¼š$($JAR_FILE.FullName)"
              $env:JAR_NAME = $JAR_FILE.Name
          }
        shell: pwsh
        env:
          JAR_PATH: ".\ruoyi-admin-wms\target\*.jar"

      # æ­¥éª¤6ï¼šå®‰è£… Launch4jï¼ˆå›½å†…é•œåƒæºï¼‰
      - name: Install Launch4j (Stable Source)
        run: |
          $launch4jUrl = "https://ghproxy.com/https://sourceforge.net/projects/launch4j/files/launch4j-3.50/launch4j-3.50-win32.zip/download"
          Invoke-WebRequest -Uri $launch4jUrl -OutFile launch4j.zip -TimeoutSec 60
          if (-not (Test-Path "launch4j.zip")) {
              Write-Error "âŒ Launch4j å‹ç¼©åŒ…ä¸‹è½½å¤±è´¥"
              exit 1
          }
          Expand-Archive -Path launch4j.zip -DestinationPath C:\launch4j -Force
          $env:PATH += ";C:\launch4j\launch4j-3.50-win32"
          if (-not (Get-Command "launch4j.exe" -ErrorAction SilentlyContinue)) {
              Write-Error "âŒ Launch4j å®‰è£…å¤±è´¥"
              exit 1
          }
          Write-Host "âœ… Launch4j å®‰è£…æˆåŠŸ"
        shell: pwsh

      # æ­¥éª¤7ï¼šç”¨ Launch4j æ‰“åŒ… EXEï¼ˆæ³¨é‡Šå›¾æ ‡ï¼Œé¿å…æŠ¥é”™ï¼‰
      - name: Package to EXE with Launch4j
        run: |
          $JAR_NAME = $env:JAR_NAME
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -Path .\windows-exe -ItemType Directory -Force
          # ç”Ÿæˆ Launch4j é…ç½®æ–‡ä»¶
          @"
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <headerType>console</headerType>
            <jar>.\ruoyi-admin-wms\target\$JAR_NAME</jar>
            <outfile>.\windows-exe\ruoyi-wms.exe</outfile>
            <errTitle></errTitle>
            <cmdLine></cmdLine>
            <chdir>.</chdir>
            <priority>normal</priority>
            <downloadUrl>https://java.com/download</downloadUrl>
            <supportUrl></supportUrl>
            <customProcName>false</customProcName>
            <stayAlive>false</stayAlive>
            <manifest></manifest>
            <!-- æ³¨é‡Šå›¾æ ‡è¡Œï¼Œåç»­æœ‰å›¾æ ‡æ–‡ä»¶å†æ¢å¤ -->
            <!-- <icon>.\ruoyi-admin-wms\src\main\resources\static\favicon.ico</icon> -->
            <jre>
              <path>$env:JAVA_HOME</path>
              <minVersion>$(${{ github.ref_name == 'v1' ? '8' : '17' }})</minVersion>
              <maxVersion></maxVersion>
              <jdkPreference>preferJre</jdkPreference>
              <runtimeBits>64/32</runtimeBits>
            </jre>
          </launch4jConfig>
          "@ | Out-File -FilePath launch4j.xml -Encoding utf8 -Force
          # æ‰§è¡Œæ‰“åŒ…
          launch4j.exe launch4j.xml
          # æ ¡éªŒ EXE æ˜¯å¦ç”Ÿæˆ
          if (-not (Test-Path ".\windows-exe\ruoyi-wms.exe")) {
              Write-Error "âŒ EXE æ‰“åŒ…å¤±è´¥ï¼Œæœªæ‰¾åˆ°ç”Ÿæˆçš„ exe æ–‡ä»¶"
              exit 1
          } else {
              Write-Host "âœ… EXE æ‰“åŒ…æˆåŠŸï¼š.\windows-exe\ruoyi-wms.exe"
          }
        shell: pwsh
        env:
          JAR_NAME: ${{ env.JAR_NAME }}

      # æ­¥éª¤8ï¼šä¸Šä¼  EXE äº§ç‰©
      - name: Upload Windows EXE
        uses: actions/upload-artifact@v4
        with:
          name: ruoyi-wms-windows-exe-${{ github.ref_name }}
          path: .\windows-exe\*.exe
          retention-days: 30
