name: 构建Windows可执行程序
on:
  push:
    branches: [ main, master ]  # 触发分支，可按需修改
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows-exe:
    runs-on: windows-latest  # 使用Windows环境的Runner
    steps:
      # 1. 检出代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 配置JDK（匹配项目使用的版本，RuoYi通常用17/8，这里以17为例）
      - name: 配置JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'  # 使用Eclipse Temurin JDK（兼容jpackage）
          cache: maven  # 缓存Maven依赖，加速构建

      # 3. Maven构建项目（生成可执行JAR包）
      - name: Maven打包（跳过测试）
        run: |
          mvn clean package -DskipTests
        # 注意：如果你的项目是多模块（如RuoYi），需指定打包的模块，例如：
        # mvn clean package -DskipTests -pl ruoyi-admin -am

      # 4. 用jpackage生成Windows EXE程序
      - name: 生成Windows可执行程序
        run: |
          # 定义变量（按需修改）
          $JAR_PATH = "./ruoyi-admin/target/ruoyi-admin.jar"  # 替换为你的JAR包实际路径
          $OUTPUT_DIR = "./windows-exe"
          $APP_NAME = "WmsRuoYi"  # EXE程序名称
          $APP_VERSION = "1.0.0"

          # 创建输出目录
          New-Item -ItemType Directory -Path $OUTPUT_DIR -Force

          # 执行jpackage打包（核心命令）
          jpackage `
            --type exe `
            --input $JAR_PATH `
            --dest $OUTPUT_DIR `
            --name $APP_NAME `
            --version $APP_VERSION `
            --main-jar (Split-Path $JAR_PATH -Leaf) `
            --main-class org.springframework.boot.loader.JarLauncher `  # Spring Boot JAR的启动类
            --win-console `  # 显示控制台窗口（便于调试，生产可移除）
            --win-dir-chooser `  # 安装时允许选择目录
            --win-shortcut `  # 创建桌面快捷方式
            --win-menu  # 创建开始菜单快捷方式

      # 5. 上传EXE产物（便于下载）
      - name: 上传Windows可执行程序
        uses: actions/upload-artifact@v4
        with:
          name: WmsRuoYi-Windows-EXE
          path: ./windows-exe/*
