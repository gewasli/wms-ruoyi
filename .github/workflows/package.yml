# 工作流名称：WMS-RuoYi 自动化打包
name: Auto Build WMS-RuoYi

# 触发条件：
# 1. 推代码/提PR到指定分支
# 2. 手动触发（Actions页面点击运行）
on:
  push:
    branches: [ lite, advance, v1, master ]
  pull_request:
    branches: [ lite, advance, v1, master ]
  workflow_dispatch: # 手动触发开关

# 核心作业：打包构建
jobs:
  build:
    runs-on: ubuntu-latest # 运行环境：最新版Ubuntu
    timeout-minutes: 30 # 超时时间：30分钟（避免构建卡死）

    steps:
      # 步骤1：检出代码到GitHub Runner
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 仅拉取最新提交，加速检出

      # 步骤2：自动识别分支并配置对应JDK版本
      # v1分支用JDK8，其他分支（lite/advance/master）用JDK17
      - name: Set JDK Version by Branch
        id: set-jdk
        run: |
          if [[ "${{ github.ref_name }}" == "v1" ]]; then
            echo "java-version=8" >> $GITHUB_OUTPUT
          else
            echo "java-version=17" >> $GITHUB_OUTPUT
          fi

      # 步骤3：配置JDK环境（Eclipse Temurin官方版本）
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.set-jdk.outputs.java-version }}
          distribution: 'temurin' # 稳定的OpenJDK发行版
          cache: 'maven' # 缓存Maven依赖，大幅加速后续构建

      # 步骤4：配置Maven阿里云镜像（解决海外拉取依赖慢/失败）
      - name: Configure Maven Settings
        run: |
          # 创建Maven配置目录
          mkdir -p ~/.m2
          # 写入阿里云镜像配置
          cat > ~/.m2/settings.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
            <mirrors>
              <mirror>
                <id>aliyunmaven</id>
                <mirrorOf>central</mirrorOf>
                <url>https://maven.aliyun.com/repository/public</url>
              </mirror>
            </mirrors>
          </settings>
          EOF

      # 步骤5：Maven打包（跳过测试加速，清理缓存避免冲突）
      - name: Build with Maven
        run: |
          # 清理本地缓存 + 打包（跳过测试）
          mvn clean package -DskipTests
          # 验证Jar包是否生成（非必需，仅用于校验）
          ls -lh ./ruoyi-admin-wms/target/*.jar || { echo "Jar包生成失败"; exit 1; }

      # 步骤6：上传打包产物（Jar包），支持下载
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wms-ruoyi-jar-${{ github.ref_name }} # 产物名称（带分支标识）
          path: ./ruoyi-admin-wms/target/*.jar # Jar包路径（匹配项目结构）
          retention-days: 7 # 产物保留7天（可根据需求调整）
          if-no-files-found: error # 无Jar包时直接报错

      # 可选步骤：打包成功后自动创建Release（适合发版场景）
      # 如需启用，取消下方注释并配置GITHUB_TOKEN
      # - name: Create GitHub Release
      #   uses: softprops/action-gh-release@v1
      #   if: github.ref == 'refs/heads/master' # 仅master分支触发
      #   with:
      #     files: ./ruoyi-admin-wms/target/*.jar
      #     tag_name: v${{ github.run_number }}
      #     name: WMS-RuoYi Build ${{ github.run_number }}
      #     body: 自动构建产物（分支：${{ github.ref_name }}）
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
