name: Build Windows Executable
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      # 1. 拉取代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. 配置JDK（匹配RuoYi的JDK8）
      - name: Set Up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: maven # 缓存Maven依赖，加速构建

      # 3. 打包RuoYi为可执行JAR（核心步骤）
      - name: Build JAR with Maven
        run: |
          # 进入项目根目录，打包ruoyi-admin模块（RuoYi主程序）
          cd ${{ github.workspace }}
          mvn clean package -DskipTests -Pprod
          # 验证JAR是否生成
          Get-ChildItem ${{ github.workspace }}\ruoyi-admin\target\*.jar

      # 4. 安装launch4j（JAR转EXE工具）
      - name: Install Launch4j
        run: |
          # 下载launch4j Windows版本
          Invoke-WebRequest -Uri "https://downloads.sourceforge.net/project/launch4j/launch4j-3/3.50/launch4j-3.50-win32.zip" -OutFile launch4j.zip
          Expand-Archive -Path launch4j.zip -DestinationPath C:\launch4j -Force
          # 加入系统PATH
          echo "C:\launch4j\launch4j-3.50-win32" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # 5. 配置launch4j并生成EXE
      - name: Build Windows EXE
        run: |
          # 编写launch4j配置文件（适配RuoYi）
          $config = @"
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <headerType>console</headerType> <!-- RuoYi是控制台程序，GUI需改gui -->
            <jar>${{ github.workspace }}\ruoyi-admin\target\ruoyi-admin.jar</jar>
            <outfile>${{ github.workspace }}\target\ruoyi-wms.exe</outfile>
            <jre>
              <minVersion>1.8.0</minVersion>
              <bundledJre64Bit>true</bundledJre64Bit>
              <jdkPreference>preferJre</jdkPreference>
            </jre>
            <versionInfo>
              <fileVersion>1.0.0.0</fileVersion>
              <productName>RuoYi WMS</productName>
              <originalFilename>ruoyi-wms.exe</originalFilename>
            </versionInfo>
          </launch4jConfig>
          "@
          # 写入配置文件
          $config | Out-File -FilePath ${{ github.workspace }}\launch4j.xml -Encoding utf8
          # 执行打包
          launch4j ${{ github.workspace }}\launch4j.xml

      # 6. 上传EXE产物（便于下载测试）
      - name: Upload EXE Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruoyi-wms-windows-exe
          path: ${{ github.workspace }}\target\ruoyi-wms.exe
