name: 构建Windows可执行程序
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Maven打包（跳过测试）
        run: mvn clean package -DskipTests
        working-directory: .  # 确保在项目根目录执行

      - name: 生成Windows可执行程序
        run: |
          # 定义变量（适配wms-ruoyi项目）
          $JAR_PATH = "./ruoyi-admin-wms/target/ruoyi-admin-wms.jar"
          $OUTPUT_DIR = "./windows-exe"
          $APP_NAME = "WmsRuoYi"
          $APP_VERSION = "1.0.0"
          $JAR_DIR = (Split-Path -Path $JAR_PATH -Parent)  # JAR所在目录
          $MAIN_JAR = (Split-Path -Path $JAR_PATH -Leaf)   # JAR文件名

          # 创建输出目录
          New-Item -ItemType Directory -Path $OUTPUT_DIR -Force

          # 关键：jpackage命令改为单行，彻底避免换行符解析问题
          & jpackage --type exe --input "$JAR_DIR" --dest "$OUTPUT_DIR" --name "$APP_NAME" --version "$APP_VERSION" --main-jar "$MAIN_JAR" --main-class org.springframework.boot.loader.JarLauncher --win-console --win-dir-chooser --win-shortcut --win-menu
        shell: pwsh
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
          PATH: ${{ env.JAVA_HOME_17_X64 }}\bin;${{ env.PATH }}

      - name: 上传Windows可执行程序
        uses: actions/upload-artifact@v4
        with:
          name: WmsRuoYi-Windows-EXE
          path: ./windows-exe/*
