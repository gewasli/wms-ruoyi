name: 构建ruoyi-wms Windows EXE（launch4j方案）
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 配置JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: 安装launch4j（ruoyi生态首选EXE打包工具）
        run: |
          # 用Chocolatey安装launch4j（Windows包管理器，CI环境预装）
          choco install launch4j -y
          # 验证安装
          launch4j --version
        shell: pwsh

      - name: Maven打包（确保生成可执行JAR）
        run: |
          # 严格按ruoyi-wms文档打包核心模块
          mvn clean package -DskipTests -Pdev -pl ruoyi-admin-wms -am
          
          # 验证JAR有效性
          $JAR_PATH = "./ruoyi-admin-wms/target/ruoyi-admin-wms.jar"
          Write-Host "JAR是否存在: $(Test-Path $JAR_PATH)"
          if (-not (Test-Path $JAR_PATH)) {
              Write-Error "❌ Maven打包失败，无JAR文件！"
              exit 1
          }
        shell: pwsh

      - name: 配置launch4j（生成打包配置文件）
        run: |
          # 创建launch4j配置文件（关键：适配Spring Boot JAR）
          $LAUNCH4J_CONFIG = "./launch4j-config.xml"
          $JAR_PATH = (Resolve-Path "./ruoyi-admin-wms/target/ruoyi-admin-wms.jar").Path
          $EXE_OUTPUT = (Resolve-Path "./windows-exe").Path
          
          # 创建输出目录
          New-Item -ItemType Directory -Path "./windows-exe" -Force | Out-Null

          # 写入launch4j配置（ruoyi-wms专用）
          Set-Content -Path $LAUNCH4J_CONFIG -Value @"
          <?xml version="1.0" encoding="UTF-8"?>
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <headerType>console</headerType>  <!-- 控制台模式，匹配ruoyi日志输出 -->
            <jar>$JAR_PATH</jar>
            <outfile>$EXE_OUTPUT\ruoyi-wms.exe</outfile>
            <errTitle>ruoyi-wms启动失败</errTitle>
            <cmdLine></cmdLine>
            <chdir>.</chdir>
            <priority>normal</priority>
            <downloadUrl>https://adoptium.net/temurin/releases/?version=17</downloadUrl>
            <supportUrl></supportUrl>
            <customProcName>false</customProcName>
            <stayAlive>false</stayAlive>
            <manifest></manifest>
            <icon></icon>
            <jre>
              <path>%JAVA_HOME%\jre</path>  <!-- 兼容系统JRE -->
              <minVersion>17</minVersion>   <!-- 匹配项目JDK版本 -->
              <maxVersion></maxVersion>
              <jdkPreference>preferJre</jdkPreference>
              <runtimeBits>64/32</runtimeBits>
            </jre>
            <versionInfo>
              <fileVersion>5.2.0.0</fileVersion>
              <fileDescription>ruoyi-wms仓储管理系统</fileDescription>
              <productVersion>5.2.0.0</productVersion>
              <productName>ruoyi-wms</productName>
              <companyName>ruoyi</companyName>
              <internalName>ruoyi-wms</internalName>
              <originalFilename>ruoyi-wms.exe</originalFilename>
            </versionInfo>
          </launch4jConfig>
          Write-Host "✅ launch4j配置文件生成完成：$LAUNCH4J_CONFIG"
        shell: pwsh

      - name: 用launch4j打包生成EXE
        run: |
          # 执行launch4j打包
          launch4j ./launch4j-config.xml
          
          # 验证EXE生成
          $EXE_FILE = "./windows-exe/ruoyi-wms.exe"
          Write-Host "EXE是否存在: $(Test-Path $EXE_FILE)"
          if (-not (Test-Path $EXE_FILE)) {
              Write-Error "❌ launch4j打包失败，无EXE文件！"
              exit 1
          }
          Write-Host "✅ EXE生成成功：$EXE_FILE"
          # 打印EXE文件信息
          Get-Item $EXE_FILE
        shell: pwsh

      - name: 上传EXE制品
        uses: actions/upload-artifact@v4
        with:
          name: ruoyi-wms-Windows-EXE
          path: ./windows-exe/ruoyi-wms.exe
          if-no-files-found: error
