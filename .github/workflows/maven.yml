name: 构建ruoyi-wms Windows可执行程序（适配官方文档）
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置JDK 17（严格匹配文档要求）
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          java-package: jdk  # 文档要求完整JDK，非JRE

      - name: 配置Maven镜像（适配文档的依赖源）
        run: |
          # 新增：匹配文档的Maven镜像配置，避免依赖下载失败
          New-Item -Path ~/.m2 -Name settings.xml -ItemType File -Force
          Set-Content -Path ~/.m2/settings.xml -Value @"
          <?xml version="1.0" encoding="UTF-8"?>
          <settings>
            <mirrors>
              <mirror>
                <id>huaweicloud</id>
                <name>华为云镜像</name>
                <url>https://mirrors.huaweicloud.com/repository/maven/</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          "@
        shell: pwsh

      - name: Maven打包（严格按文档规范执行）
        run: |
          Write-Host "=== 按ruoyi-wms文档规范打包 ==="
          # 核心：指定admin模块+依赖，激活dev profile（匹配文档默认环境）
          mvn clean package -DskipTests -Pdev -pl ruoyi-admin-wms -am
          
          # 验证打包结果（文档要求的可执行JAR）
          $JAR_PATH = "./ruoyi-admin-wms/target/ruoyi-admin-wms.jar"
          Write-Host "JAR路径: $JAR_PATH"
          Write-Host "JAR是否存在: $(Test-Path $JAR_PATH)"
          if (-not (Test-Path $JAR_PATH)) {
              Write-Error "❌ 未找到JAR包，打包失败！"
              Get-ChildItem -Recurse -Path ./ruoyi-admin-wms/target
              exit 1
          }
          # 验证文档要求的主类是否存在
          & jar tf $JAR_PATH | Select-String -Pattern "com/ruoyi/RuoYiApplication.class"
          if (-not $?) {
              Write-Error "❌ JAR中无文档指定的主类com.ruoyi.RuoYiApplication！"
              exit 1
          }
        shell: pwsh

      - name: 生成Windows EXE（适配文档运行规则）
        run: |
          # 变量定义（匹配文档的项目结构）
          $JAR_PATH = "./ruoyi-admin-wms/target/ruoyi-admin-wms.jar"
          $OUTPUT_DIR = "./windows-exe"
          $APP_NAME = "ruoyi-wms"
          $APP_VERSION = "5.2.0"  # 匹配文档的项目版本
          $JAR_DIR = Split-Path -Path $JAR_PATH -Parent
          $MAIN_JAR = Split-Path -Path $JAR_PATH -Leaf

          # 创建输出目录
          New-Item -ItemType Directory -Path $OUTPUT_DIR -Force | Out-Null

          Write-Host "=== 执行jpackage（适配文档规则）==="
          # 核心：简化jpackage命令，匹配文档的运行要求（去掉复杂参数，优先保证生成）
          $jpackageCmd = @(
              "--type", "exe",
              "--input", "`"$JAR_DIR`"",
              "--dest", "`"$OUTPUT_DIR`"",
              "--name", "`"$APP_NAME`"",
              "--version", "`"$APP_VERSION`"",
              "--main-jar", "`"$MAIN_JAR`"",
              "--main-class", "org.springframework.boot.loader.JarLauncher",  # 文档隐含的Spring Boot启动类
              "--win-console",  # 文档要求显示控制台日志
              "--verbose",
              "--log-file", "`"$OUTPUT_DIR/jpackage.log`""
          )

          # 执行jpackage（无管理员权限，匹配文档的普通运行规则）
          & jpackage $jpackageCmd
          $JPACKAGE_EXIT_CODE = $LASTEXITCODE

          # 输出文档排查所需的日志
          Write-Host "=== jpackage日志（适配文档排查）==="
          if (Test-Path "$OUTPUT_DIR/jpackage.log") {
              Get-Content "$OUTPUT_DIR/jpackage.log"
          }

          # 验证结果
          if ($JPACKAGE_EXIT_CODE -ne 0) {
              Write-Error "❌ jpackage执行失败，退出码: $JPACKAGE_EXIT_CODE"
              exit 1
          }
          $EXE_FILE = Get-ChildItem -Path $OUTPUT_DIR -Filter "*.exe" -ErrorAction SilentlyContinue
          if (-not $EXE_FILE) {
              Write-Error "❌ 未生成EXE文件！"
              exit 1
          }
          Write-Host "✅ EXE生成成功: $($EXE_FILE.FullName)"
        shell: pwsh
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
          PATH: ${{ env.JAVA_HOME_17_X64 }}\bin;${{ env.PATH }}

      - name: 上传EXE制品（匹配文档交付规范）
        uses: actions/upload-artifact@v4
        with:
          name: ruoyi-wms-Windows-EXE
          path: |
            ./windows-exe/**/*
            ./ruoyi-admin-wms/target/ruoyi-admin-wms.jar  # 额外上传JAR，方便文档对照排查
          if-no-files-found: error
